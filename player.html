<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="https://i.postimg.cc/YC3Npf10/image.webp">
    <style>
        /* Custom styles for the Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000; /* Black background for player page */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scrollbars due to loading animation */
        }

        /* Styling for the loading animation */
        .loading {
            position: fixed; /* Cover the entire screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Semi-transparent black overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Ensure it's on top */
        }

        .loading-text {
            font-size: 3.5rem; /* Slightly larger text */
            font-weight: bold;
            color: #fff;
            display: flex;
            letter-spacing: 0.2em; /* Add some letter spacing */
        }

        .loading-text-words {
            animation: pulse-fade 2s infinite ease-in-out; /* Smoother, pulsing animation */
            display: inline-block;
            margin: 0 0.2rem;
            opacity: 0.7; /* Start slightly faded */
            transform: translateY(0) scale(1);
        }

        /* Delay animation and set a gradient of colors for each letter */
        .loading-text-words:nth-child(1) { animation-delay: 0.1s; color: #8B5CF6; /* Violet */ }
        .loading-text-words:nth-child(2) { animation-delay: 0.2s; color: #6366F1; /* Indigo */ }
        .loading-text-words:nth-child(3) { animation-delay: 0.3s; color: #3B82F6; /* Blue */ }
        .loading-text-words:nth-child(4) { animation-delay: 0.4s; color: #06B6D4; /* Cyan */ }
        .loading-text-words:nth-child(5) { animation-delay: 0.5s; color: #10B981; /* Emerald */ }
        .loading-text-words:nth-child(6) { animation-delay: 0.6s; color: #F59E0B; /* Amber */ }
        .loading-text-words:nth-child(7) { animation-delay: 0.7s; color: #EF4444; /* Red */ }


        @keyframes pulse-fade {
            0%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-8px) scale(1.05); /* Softer bounce, slight scale */
                opacity: 1; /* Fully visible at peak */
            }
        }

        /* Ensure JW Player container takes full width and height */
        #jwplayerDiv {
            width: 100vw; /* Viewport width */
            height: 100vh; /* Viewport height */
            display: flex; /* Use flexbox to center player if needed */
            justify-content: center;
            align-items: center;
        }

        /* Override JW Player default styles if necessary for responsiveness */
        .jwplayer {
            width: 100% !important;
            height: 100% !important;
        }

        /* Custom Floating Controls Styling */
        .floating-controls {
            position: absolute;
            right: 1rem; /* Distance from right edge */
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Space between buttons */
            z-index: 100; /* Ensure controls are above the player */
            opacity: 1; /* Default visible when not in fullscreen or on activity */
            transition: opacity 0.3s ease-in-out; /* Smooth transition for hiding/showing */
        }

        /* When in fullscreen, controls are initially hidden, only show on hover/activity */
        .jwplayer-fullscreen .floating-controls {
            opacity: 0;
        }

        /* When in fullscreen and controls are active/hovered */
        .jwplayer-fullscreen .floating-controls.active {
            opacity: 1;
        }

        .control-button {
            width: 3.5rem; /* Round button size */
            height: 3.5rem;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1); /* Transparent white background */
            backdrop-filter: blur(10px); /* Glass effect */
            -webkit-backdrop-filter: blur(10px); /* Safari support */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); /* Soft shadow */
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- JW Player Library -->
    <script src="https://cdn.jwplayer.com/libraries/SAHhwvZq.js"></script>

    <!-- The div where JW Player will be embedded -->
    <div id="jwplayerDiv" class="relative"></div>

    <!-- Loading animation -->
    <div id="loading" class="loading">
        <div class="loading-text">
            <span class="loading-text-words">L</span>
            <span class="loading-text-words">O</span>
            <span class="loading-text-words">A</span>
            <span class="loading-text-words">D</span>
            <span class="loading-text-words">I</span>
            <span class="loading-text-words">N</span>
            <span class="loading-text-words">G</span>
        </div>
    </div>

    <!-- Custom Floating Controls -->
    <div class="floating-controls" id="floatingControls">
        <button id="fullscreenButton" class="control-button" onclick="toggleFullscreen()">
            <i class="fas fa-expand"></i>
        </button>
        <button id="muteButton" class="control-button" onclick="toggleMute()">
            <i class="fas fa-volume-up"></i>
        </button>
        <button onclick="window.location.href='index.html'"
                class="control-button bg-gray-700 hover:bg-gray-600 text-white text-sm">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <script>
        let playerInstance; // Declare playerInstance globally
        let hideControlsTimeout; // To manage the timeout for hiding controls
        const INACTIVITY_TIMEOUT = 3000; // 3 seconds of inactivity before hiding controls

        /**
         * Shows the floating controls.
         */
        function showControls() {
            const floatingControls = document.getElementById('floatingControls');
            if (floatingControls) {
                floatingControls.classList.add('active');
                // Clear any existing timeout to keep controls visible
                clearTimeout(hideControlsTimeout);
                // Set a new timeout to hide controls after inactivity
                if (playerInstance && playerInstance.getFullscreen()) {
                    hideControlsTimeout = setTimeout(hideControls, INACTIVITY_TIMEOUT);
                }
            }
        }

        /**
         * Hides the floating controls.
         */
        function hideControls() {
            const floatingControls = document.getElementById('floatingControls');
            if (floatingControls) {
                floatingControls.classList.remove('active');
            }
        }

        /**
         * Handles user activity (mousemove or keydown) to show/hide controls.
         */
        function handleUserActivity() {
            if (playerInstance && playerInstance.getFullscreen()) {
                showControls();
            }
        }

        /**
         * Main function to initialize and configure JW Player.
         */
        function initializePlayer() {
            // Get URL query parameters
            const queryParams = new URLSearchParams(window.location.search);
            const fullLink = queryParams.get('fullLink');

            let mediaUrl = null;
            let keyId = null;
            let key = null;

            // Parse the fullLink string if it exists
            if (fullLink) {
                const decodedFullLink = decodeURIComponent(fullLink);
                const parts = decodedFullLink.split('~');
                mediaUrl = parts[0];

                if (parts.length > 1) {
                    const drmParamsString = parts[1];
                    const tempSearchParams = new URLSearchParams(drmParamsString);
                    const drmLicense = tempSearchParams.get('drmLicense');

                    if (drmLicense) {
                        const drmParts = drmLicense.split(':');
                        if (drmParts.length === 2) {
                            keyId = drmParts[0];
                            key = drmParts[1];
                        } else {
                            console.warn('Invalid drmLicense format within fullLink. Expected "keyId:key".');
                        }
                    }
                }
            } else {
                // Fallback to previous query parameter logic if fullLink is not provided
                mediaUrl = queryParams.get('mpd') || queryParams.get('m3u8');
                keyId = queryParams.get('keyId');
                key = queryParams.get('key');
                const drmLicense = queryParams.get('drmLicense');

                if (drmLicense) {
                    const parts = drmLicense.split(':');
                    if (parts.length === 2) {
                        keyId = parts[0];
                        key = parts[1];
                    } else {
                        console.warn('Invalid drmLicense format. Expected "keyId:key".');
                    }
                }
            }

            // Base JW Player configuration
            let playerConfig = {
                autostart: true,
                preload: "auto",
                repeat: false,
                volume: 100,
                mute: false,
                stretching: "uniform",
                width: "100%",
                height: "100%",
                controls: false, // IMPORTANT: Disable default JW Player controls
                cast: {},
                setPip: true,
                primary: "html5",
                skin: {
                    name: "Denver",
                    active: "#3B82F6",
                    inactive: "#D1D5DB",
                    background: "#1F2937"
                },
            };

            // Configure player based on media type and URL
            if (mediaUrl) {
                playerConfig.file = mediaUrl;

                if (mediaUrl.includes('.mpd')) {
                    playerConfig.type = "dash";
                } else if (mediaUrl.includes('.m3u8')) {
                    playerConfig.type = "hls";
                } else {
                    console.log('Media URL is not .mpd or .m3u8, letting JW Player auto-detect type.');
                }

                if (keyId && key) {
                    playerConfig.drm = {
                        clearkey: {
                            key: key,
                            keyId: keyId
                        }
                    };
                } else {
                    playerConfig.drm = {};
                }
            } else {
                const jwplayerDiv = document.getElementById('jwplayerDiv');
                jwplayerDiv.innerHTML = '<p class="text-white text-xl text-center">No media link provided. Please go back and enter a valid link.</p>';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // Initialize JW Player
            playerInstance = jwplayer('jwplayerDiv').setup(playerConfig);

            playerInstance.on('ready', function() {
                console.log('JW Player is ready!');
                hideLoadingAnimation();
            });

            // Event listener for fullscreen changes to update button icon and control visibility
            playerInstance.on('fullscreen', function(event) {
                const fullscreenButton = document.getElementById('fullscreenButton');
                const jwplayerContainer = document.getElementById('jwplayerDiv'); // Get the player container
                if (fullscreenButton) {
                    fullscreenButton.innerHTML = event.fullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
                }

                if (event.fullscreen) {
                    // When entering fullscreen, show controls briefly and start inactivity timer
                    document.documentElement.classList.add('jwplayer-fullscreen'); // Add class to html for CSS targeting
                    showControls();
                    // Add event listeners for user activity
                    jwplayerContainer.addEventListener('mousemove', handleUserActivity);
                    document.addEventListener('keydown', handleUserActivity);
                } else {
                    // When exiting fullscreen, ensure controls are always visible and remove listeners
                    document.documentElement.classList.remove('jwplayer-fullscreen');
                    clearTimeout(hideControlsTimeout); // Clear any pending hide timeout
                    showControls(); // Ensure controls are visible when not in fullscreen
                    jwplayerContainer.removeEventListener('mousemove', handleUserActivity);
                    document.removeEventListener('keydown', handleUserActivity);
                }
            });

            // Event listener for mute changes to update button icon
            playerInstance.on('mute', function(event) {
                const muteButton = document.getElementById('muteButton');
                if (muteButton) {
                    muteButton.innerHTML = event.mute ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                }
            });

            playerInstance.on('error', function(event) {
                console.error('JW Player Error:', event);
                const jwplayerDiv = document.getElementById('jwplayerDiv');
                jwplayerDiv.innerHTML = `<p class="text-red-500 text-xl text-center">Error playing media: ${event.message}. Please check the link and keys.</p>`;
                hideLoadingAnimation();
            });
        }

        /**
         * Toggles fullscreen mode for the player.
         */
        function toggleFullscreen() {
            if (playerInstance) {
                playerInstance.setFullscreen(!playerInstance.getFullscreen());
            }
        }

        /**
         * Toggles mute/unmute for the player.
         */
        function toggleMute() {
            if (playerInstance) {
                playerInstance.setMute(!playerInstance.getMute());
            }
        }

        /**
         * Function to hide the loading animation.
         */
        function hideLoadingAnimation() {
            setTimeout(() => {
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.opacity = '0';
                    loadingElement.style.transition = 'opacity 0.5s ease-out';
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                    }, 500);
                }
            }, 2000);
        }

        // Initialize player and hide loading animation when the window loads
        window.onload = initializePlayer;
    </script>
</body>
</html>
